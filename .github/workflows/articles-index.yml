name: Generate Articles Index (HTML)

on:
  push:
    paths:
      - "articles/*.md"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate articles index.html
        run: |
          mkdir -p articles

          # ---------- HTML TEMPLATE ----------
          cat << 'EOF' > articles/index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>Articles</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                             Roboto, Helvetica, Arial, sans-serif;
                max-width: 720px;
                margin: 60px auto;
                padding: 0 20px;
                line-height: 1.6;
                color: #222;
              }
              h1 {
                font-size: 2rem;
                margin-bottom: 0.5em;
              }
              h2 {
                font-size: 1.25rem;
                margin-bottom: 0.2em;
              }
              h3 {
                font-size: 1rem;
                font-weight: normal;
                color: #555;
                margin-top: 0;
                margin-bottom: 0.5em;
              }
              .article {
                margin-bottom: 2em;
              }
              .links a {
                margin-right: 12px;
                text-decoration: none;
                color: #0066cc;
              }
              .links a:hover {
                text-decoration: underline;
              }
              .md-note {
                margin-top: 4em;
                padding-top: 1em;
                border-top: 1px solid #eee;
                font-size: 0.9rem;
                color: #555;
              }
            </style>
          </head>
          <body>
            <h1>Articles</h1>
            <p>Personal essays and technical reflections.</p>

            <!-- ARTICLES_PLACEHOLDER -->

            <div class="md-note">
              <p><strong>ðŸ“„ Reading Markdown files</strong></p>
              <p>
                This page links directly to <code>.md</code> files.
                To read them comfortably in your browser,
                install a Markdown reader extension.
              </p>
              <p>
                ðŸ‘‰ <a href="https://md-reader.github.io/" target="_blank">
                  Markdown Reader Extension
                </a>
              </p>
            </div>
          </body>
          </html>
          EOF

          # ---------- COLLECT ARTICLES ----------
          declare -A title_en
          declare -A title_zh
          declare -A file_en
          declare -A file_zh

          for file in articles/*.md; do
            name=$(basename "$file")
            base=$(echo "$name" | cut -d. -f1)
            lang=$(echo "$name" | cut -d. -f2)
            title=$(head -n 1 "$file" | sed 's/^# //')

            if [ "$lang" = "en" ]; then
              title_en["$base"]="$title"
              file_en["$base"]="$name"
            elif [ "$lang" = "zh" ]; then
              title_zh["$base"]="$title"
              file_zh["$base"]="$name"
            fi
          done

          # ---------- BUILD HTML BLOCK ----------
          articles_html=""

          bases=$(printf "%s\n" "${!file_en[@]}" "${!file_zh[@]}" | sort -u)

          for base in $bases; do
            articles_html+="<div class=\"article\">"

            if [ -n "${title_en[$base]}" ]; then
              articles_html+="<h2>${title_en[$base]}</h2>"
            else
              articles_html+="<h2>$base</h2>"
            fi

            if [ -n "${title_zh[$base]}" ]; then
              articles_html+="<h3>${title_zh[$base]}</h3>"
            fi

            articles_html+="<div class=\"links\">"

            if [ -n "${file_en[$base]}" ]; then
              articles_html+="<a href=\"${file_en[$base]}\">English</a>"
            fi

            if [ -n "${file_zh[$base]}" ]; then
              articles_html+="<a href=\"${file_zh[$base]}\">ä¸­æ–‡</a>"
            fi

            articles_html+="</div></div>"
          done

          # ---------- INJECT INTO TEMPLATE ----------
          sed -i "s|<!-- ARTICLES_PLACEHOLDER -->|$articles_html|" articles/index.html

      - name: Commit index.html
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add articles/index.html
          git commit -m "chore: auto-generate articles index.html" || echo "No changes"
          git push
