<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToU é›»è²»åˆ†æå™¨ï¼ˆæœ¬åœ°åˆ†æï¼Œç„¡å¾Œè‡ºï¼‰</title>

  <!-- CDN: dayjs, PapaParse, SheetJS, Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script>dayjs.extend(dayjs_plugin_utc); dayjs.extend(dayjs_plugin_timezone);</script>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans","Helvetica Neue",Arial;line-height:1.45;margin:20px;background:#fafafa;color:#111}
    .card{background:white;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(10,10,10,0.06);margin-bottom:16px}
    h1{margin:0 0 8px 0;font-size:20px}
    label{display:block;margin-bottom:6px;font-weight:600}
    input[type=file]{margin-bottom:8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    .col.clearfix,.col.col_header{flex-basis:100%;}
    .col.col_header{font-weight: bold;font-size: 18px;border-top:1px solid #000;padding-top:5px;}
    .small{font-size:13px;color:#555}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border:1px solid #eee;text-align:left;font-size:13px}
    .btn{background:#2563eb;color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .muted{color:#666;font-size:13px}
    #charts{display:flex;gap:16px;flex-wrap:wrap}
    canvas{background:white;border-radius:8px;padding:8px}
    canvas#pieChart{width:380px !important;height:280px !important;}
    canvas#barChart{width:600px !important;height:280px !important;}
  </style>
</head>
<body>
  <div class="card">
    <h1>ToU é›»è²»åˆ†æå™¨ï¼ˆé›¢ç·šï¼‰</h1>
    <div class="small">æŠŠä½ çš„åŠå°æ™‚ï¼ˆæˆ–å°æ™‚ï¼‰ç´€éŒ„ä¸Šå‚³ï¼ˆCSV æˆ– XLSXï¼‰ã€‚æ—¥æœŸæ¬„æ‡‰å« UTC æˆ– ISO æ™‚é–“å­—ä¸²ï¼Œä¾‹å¦‚ <code>2025-10-12 00:00:00</code> æˆ– <code>20-10-2025 00:00</code>ã€‚æ­¤å·¥å…·æœƒæŠŠæ™‚é–“è½‰æˆé¦¬ä¾†è¥¿äºæ™‚å€ï¼ˆUTC+8ï¼‰ï¼Œä¸¦å°‡ç´€éŒ„åˆ†æˆï¼šå¹³æ—¥ Peakï¼ˆé€±ä¸€â€“é€±äº” 14:00â€“22:00ï¼‰ã€å¹³æ—¥ Off-Peakã€é€±æœ«ï¼ˆé€±å…­/é€±æ—¥ï¼‰ã€‚å…¨éƒ¨åœ¨æœ¬æ©Ÿç€è¦½å™¨è™•ç†ï¼Œä¸æœƒä¸Šå‚³ã€‚</div>
  </div>

  <div class="card">
    <label>ä¸Šå‚³æª”æ¡ˆï¼ˆCSV æˆ– Excelï¼‰</label>
    <input id="fileInput" type="file" accept=".csv, .xlsx, .xls" />
    <div class="muted">æ”¯æ´ CSV æ¬„å: åŒ…å« "Date" æˆ– "date"ï¼›èƒ½æºæ•¸å€¼æ¬„å: "Total", "Usage (kWh)" æˆ– "Usage"ã€‚è‹¥ä½ ä½¿ç”¨ä¸åŒæ¬„åï¼Œæœƒæç¤ºä½ é¸æ¬„ä½ã€‚</div>
  </div>

  <div class="card" id="optionsCard" style="display:none;">
    <h2 style="font-size:16px;margin-bottom:8px">é›»åƒ¹è¨­å®šï¼ˆå¯ç·¨è¼¯ï¼‰</h2>
    <div class="row">
      <div class="col col_header">èˆŠæ–¹æ¡ˆ</div>
      <div class="col">
        <label>Tenaga (RM/kWh)</label>
        <input id="rateTenaga" type="number" step="0.0001" value="0.2703" />
      </div>
      <!-- <div class="col">
        <label>Kapasiti (RM/kWh)</label>
        <input id="rateKapasiti" type="number" step="0.0001" value="0.0455" />
      </div>
      <div class="col">
        <label>Caj Rangkaian (RM/kWh)</label>
        <input id="rateRangkaian" type="number" step="0.0001" value="0.1285" />
      </div>
      <div class="col">
        <label>æŠ˜æ‰£ â€” Insentif Cekap Tenaga (-RM/kWh)</label>
        <input id="rateDiscount" type="number" step="0.0001" value="-0.075" />
      </div> -->
      <div class="col clearfix">
        <p class="small" style="margin-top:8px;color:#555;">*no include Kapasiti, Caj Rangkaian, Insentif Cekap Tenaga, AFA discount, service tax 8% and KWTBB (Renewable Energy Fund) 1.6%</p>
      </div>
      <div class="col col_header">æ–°æ–¹æ¡ˆ</div>
      <div class="col">
        <label>Peakï¼ˆRM / kWhï¼‰</label>
        <input id="ratePeak" type="number" step="0.001" value="0.2852" />        
      </div>
      <div class="col">
        <label>Off-Peakï¼ˆRM / kWhï¼‰</label>
        <input id="rateOff"  type="number" step="0.001" value="0.2443" />
      </div>
      <div class="col clearfix">
        <p class="small" style="margin-top:8px;color:#555;">*Peak hours are from 2 p.m. to 10 p.m. on weekdays, while off-peak hours include all day on weekends and from 10 p.m. to 2 p.m. on weekdays.</p>
        <p class="small" style="margin-top:8px;color:#555;">
          âš ï¸ æ³¨æ„ï¼šè‹¥æ¯æœˆç¸½ç”¨é›»è¶…é 1500 kWhï¼ŒToU è²»ç‡å°‡æå‡è‡³ Off-Peak RM 0.3443 / Peak RM 0.3852 æ¯ kWhã€‚æœ¬å·¥å…·åƒ…ä»¥ 1500 kWh ä»¥ä¸‹ç´šè·è¨ˆç®—ã€‚
        </p>
      </div>
    </div>    
    <div style="margin-top:12px" class="row">
      <button id="analyzeBtn" class="btn">åˆ†æä¸¦é¡¯ç¤ºçµæœ</button>
      <button id="exportBtn" class="btn" style="background:#10b981" disabled>åŒ¯å‡ºçµæœ CSV</button>
    </div>
  </div>

  <div id="resultArea" style="display:none;">
    <div class="card">
      <h2 style="font-size:16px">æ‘˜è¦</h2>
      <div id="summaryText" class="small"></div>
    </div>

    <div class="card" id="charts">
      <div style="width:380px">
        <canvas id="pieChart" width="380" height="280"></canvas>
      </div>
      <div style="flex:1;min-width:280px">
        <canvas id="barChart" width="600" height="280"></canvas>
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:16px">æ˜ç´°ï¼ˆå‰ 50 ç­†ç¤ºä¾‹ï¼‰</h2>
      <div id="tableWrap" style="max-height:260px;overflow:auto"></div>
    </div>
  </div>

<script>
/*
  åŠŸèƒ½è¦é»ï¼š
  - æ”¯æ´ CSVï¼ˆPapaParseï¼‰èˆ‡ Excelï¼ˆSheetJSï¼‰
  - è‡ªå‹•å°‹æ‰¾ date èˆ‡ total æ¬„ä½ï¼›è‹¥ä¸ç¢ºå®šï¼Œæç¤ºä½¿ç”¨è€…æ‰‹å‹•é¸æ¬„
  - è½‰æ›ç‚º MYTï¼ˆUTC+8ï¼‰ä¸¦ä¾è¦å‰‡åˆ†é¡ç‚º Peak / Off-Peak / Weekend
  - æ ¹æ“šä½¿ç”¨è€…è¼¸å…¥çš„è²»ç‡è¨ˆç®—èˆŠ/æ–°è²»ç”¨ï¼Œä¸¦é¡¯ç¤ºå·®ç•°
  - é¡¯ç¤ºåœ“é¤…èˆ‡é•·æ¢åœ–ï¼Œä¸¦å¯åŒ¯å‡ºåˆ†æçµæœ
*/

let rawRows = [];
let parsedRecords = []; // {utcDate: Date, myt: dayjs, total: number, period: 'Weekday Peak'|'Weekday Off-Peak'|'Weekend'}

const fileInput = document.getElementById('fileInput');
const optionsCard = document.getElementById('optionsCard');
const analyzeBtn = document.getElementById('analyzeBtn');
const exportBtn = document.getElementById('exportBtn');
const resultArea = document.getElementById('resultArea');
const summaryText = document.getElementById('summaryText');

let pieChart = null;
let barChart = null;

fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const name = f.name.toLowerCase();
  rawRows = [];
  parsedRecords = [];
  resultArea.style.display = 'none';
  exportBtn.disabled = true;

  if (name.endsWith('.csv')) {
    Papa.parse(f, {
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: (res) => {
        rawRows = res.data;
        afterLoad();
      },
      error: (err) => alert('è§£æ CSV ç™¼ç”ŸéŒ¯èª¤: ' + err.message)
    });
  } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const data = new Uint8Array(ev.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const firstName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstName];
      rawRows = XLSX.utils.sheet_to_json(sheet, {defval: null});
      afterLoad();
    };
    reader.readAsArrayBuffer(f);
  } else {
    alert('åƒ…æ”¯æ´ CSV æˆ– Excel (.xlsx/.xls)');
  }
});

function guessColumns(rows) {
  if (!rows || rows.length === 0) return {};
  const cols = Object.keys(rows[0]).map(c => c.trim());
  const lower = cols.map(c => c.toLowerCase());
  // date candidates
  const dateCandidates = ['date','timestamp','time','datetime'];
  const totalCandidates = ['total','usage (kwh)','usage','kwh','consumption'];

  let dateCol = null, totalCol = null;
  for (let i=0;i<lower.length;i++){
    if (!dateCol && dateCandidates.includes(lower[i])) dateCol = cols[i];
    if (!totalCol && totalCandidates.includes(lower[i])) totalCol = cols[i];
  }
  // fallback: find first column that looks like date by sampling values
  if (!dateCol) {
    for (let i=0;i<cols.length;i++) {
      const sample = String(rows[0][cols[i]]||'');
      if (sample.match(/\d{4}-\d{2}-\d{2}/) || sample.match(/\d{2}:\d{2}:\d{2}/)) {
        dateCol = cols[i];
        break;
      }
    }
  }
  // fallback: pick numeric column for total
  if (!totalCol) {
    for (let i=0;i<cols.length;i++){
      const v = rows[0][cols[i]];
      if (typeof v === 'number') { totalCol = cols[i]; break; }
      if (!isNaN(parseFloat(String(v).replace(/,/g,'')))) { totalCol = cols[i]; break; }
    }
  }
  return {dateCol, totalCol, cols};
}

async function afterLoad() {
  const guess = guessColumns(rawRows);
  if (!guess.dateCol || !guess.totalCol) {
    let msg = 'æ‰¾ä¸åˆ°æ—¥æœŸæˆ–æ•¸å€¼æ¬„ä½ã€‚\n';
    msg += 'æ¬„ä½æ¸…å–®ï¼š\n' + guess.cols.join(', ') + '\n\n';
    msg += 'è«‹ç¢ºèªä½ çš„æª”æ¡ˆæ˜¯å¦åŒ…å«æ—¥æœŸèˆ‡ç”¨é›»é‡ï¼ˆkWhï¼‰æ¬„ä½ï¼Œæˆ–æŠŠæ¬„åæ”¹ç‚º Date èˆ‡ Total å†ä¸Šå‚³ã€‚';
    alert(msg);
    return;
  }

  // è§£ææ¯ç­† row
  parsedRecords = [];
  for (const r of rawRows) {
    const rawDate = r[guess.dateCol];
    if (!rawDate) continue;
    // å˜—è©¦å¹¾ç¨®æ—¥æœŸè§£ææ–¹å¼
    let utc = null;
    try {
      const raw = String(rawDate).trim();
      // if it's Excel date number, SheetJS gave a number -> convert
      if (typeof rawDate === 'number') {
        utc = dayjs(new Date(Math.round((rawDate - 25569)*86400*1000))).utc(); // excel serial -> date (approx)
      } else if (/^\d{2}-\d{2}-\d{4} \d{2}:\d{2}/.test(raw)) {
        // detect DD-MM-YYYY HH:mm
        const [d, m, y, h, min] = raw.match(/\d+/g).map(Number);
        const jsDate = new Date(Date.UTC(y, m - 1, d, h, min));
        utc = dayjs(jsDate);
      } else {
        utc = dayjs.utc(String(rawDate).trim());
        if (!utc.isValid()) {
          // try native parse
          utc = dayjs(String(rawDate).trim());
          if (!utc.isValid()) continue;
          // assume it's local but original is likely UTC; still proceed
          utc = utc.utc();
        }
      }
    } catch (e) {
      continue;
    }

    const myt = utc.add(8, 'hour'); // UTC -> MYT
    const hour = myt.hour();
    const weekday = myt.day(); // 0 sunday ... 6 saturday
    const rawTotal = r[guess.totalCol];
    const total = Number(String(rawTotal).replace(/,/g,'') || 0) || 0;

    let period = 'Weekday Off-Peak';
    if (weekday === 6 || weekday === 0) period = 'Weekend';
    else {
      // Mon-Fri -> peak 14:00-22:00 (å«14ï¼Œä¸å«22)
      if (hour >= 14 && hour < 22) period = 'Weekday Peak';
      else period = 'Weekday Off-Peak';
    }

    parsedRecords.push({
      utcDate: utc.toDate(),
      myt: myt,
      hour, weekday, total, period,
      raw: r
    });
  }

  if (parsedRecords.length === 0) {
    alert('è§£æå¾Œæœªå–å¾—ä»»ä½•å¯ç”¨ç´€éŒ„ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼èˆ‡æ—¥æœŸæ¬„ä½ã€‚');
    return;
  }

  optionsCard.style.display = 'block';
  resultArea.style.display = 'none';
  summaryText.innerHTML = `<strong>å·²è¼‰å…¥ ${parsedRecords.length} ç­†ç´€éŒ„</strong>ï¼ˆç¤ºä¾‹é¡¯ç¤ºå‰ 50 ç­†ï¼‰ã€‚è«‹ç¢ºèªé›»åƒ¹å¾ŒæŒ‰ã€Œåˆ†æä¸¦é¡¯ç¤ºçµæœã€ã€‚`;
}

analyzeBtn.addEventListener('click', () => {
  if (!parsedRecords || parsedRecords.length === 0) { alert('è«‹å…ˆä¸Šå‚³æª”æ¡ˆ'); return; }

  const rateTenaga = parseFloat(document.getElementById('rateTenaga').value) || 0;
  // const rateKapasiti = parseFloat(document.getElementById('rateKapasiti').value) || 0;
  // const rateRangkaian = parseFloat(document.getElementById('rateRangkaian').value) || 0;
  // const rateDiscount = parseFloat(document.getElementById('rateDiscount').value) || 0;
  const rateOld = rateTenaga;// + rateKapasiti + rateRangkaian + rateDiscount;

  const ratePeak = parseFloat(document.getElementById('ratePeak').value) || 0;
  const rateOff = parseFloat(document.getElementById('rateOff').value) || 0;  

  // aggregate
  let weekdayPeak = 0, weekdayOff = 0, weekend = 0;
  for (const r of parsedRecords) {
    if (r.period === 'Weekday Peak') weekdayPeak += r.total;
    else if (r.period === 'Weekday Off-Peak') weekdayOff += r.total;
    else weekend += r.total;
  }
  const total = weekdayPeak + weekdayOff + weekend;

  // costs
  const costOld = total * rateOld;
  const costNew = weekdayPeak*ratePeak + (weekdayOff + weekend)*rateOff;
  const diff = costOld - costNew;
  const percent = costOld === 0 ? 0 : (diff / costOld * 100);

  // summary text
  summaryText.innerHTML = `
  <div>å–å¾—çš„ç´€éŒ„å…± <strong>${parsedRecords.length}</strong> ç­†ã€‚</div>
  <div>å¤©æ•¸ï¼š <strong>${Math.ceil(parsedRecords.length / 48)}</strong> å¤©ï¼ˆå‡è¨­åŠå°æ™‚ç´€éŒ„ï¼‰ã€‚</div>
    <div><strong>ç”¨é›»ç¸½é‡ï¼š</strong>${total.toFixed(3)} kWh</div>
    <div style="margin-top:6px">
      <strong>åˆ†å€ç”¨é›» (kWh)ï¼š</strong>
      Weekday Peak ${weekdayPeak.toFixed(3)} /
      Weekday Off-Peak ${weekdayOff.toFixed(3)} /
      Weekend ${weekend.toFixed(3)}
    </div>
    <div style="margin-top:8px"><strong>è²»ç”¨æ¯”è¼ƒï¼ˆRMï¼‰</strong></div>
    <div>
      èˆŠæ–¹æ¡ˆ<br>
      Tenaga ${rateOld.toFixed(4)} * ${total.toFixed(3)} kWh ï¼š RM ${costOld.toFixed(2)}
    </div>
    <div>æ–°æ–¹æ¡ˆ<br>
      ToUï¼ˆPeak rate ${ratePeak.toFixed(3)} * ${weekdayPeak.toFixed(3)} kWh + Off-Peak rate ${rateOff.toFixed(3)} * (Off-peak ${weekdayOff.toFixed(3)} kWh + weekend ${weekend.toFixed(3)} kWh))ï¼š RM ${costNew.toFixed(2)}</div>
    <div style="margin-top:6px">${diff>=0 ? 'ğŸ’¡ ToU æ¯”èˆŠæ–¹æ¡ˆçœä¸‹' : 'âš ï¸ ToU æ¯”èˆŠæ–¹æ¡ˆå¤šèŠ±'} RM ${Math.abs(diff).toFixed(2)} ï¼ˆ${Math.abs(percent).toFixed(2)}%ï¼‰</div>
    <div class="small">*å‰ç«¯é¡¯ç¤ºçš„æ•¸å€¼ç¶“éæ ¼å¼åŒ–ï¼Œå¾Œè‡ºæœƒç”¨å®Œæ•´è¼ƒé•·çš„è™Ÿç¢¼é€²è¡Œæº–ç¢ºè¨ˆç®—</div>
  `;

  // charts
  renderCharts({weekdayPeak, weekdayOff, weekend, total});

  // show sample table
  renderTable(parsedRecords.slice(0,50));

  resultArea.style.display = 'block';
  exportBtn.disabled = false;

  // store last results for export
  lastResult = {weekdayPeak, weekdayOff, weekend, total, costOld, costNew, diff, percent, rateOld, ratePeak, rateOff, records: parsedRecords};
});

// chart rendering
function renderCharts({weekdayPeak, weekdayOff, weekend, total}) {
  console.log('renderCharts', {weekdayPeak, weekdayOff, weekend, total});
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  const barCtx = document.getElementById('barChart').getContext('2d');

  const pieData = {
    labels: ['Weekday Peak','Weekday Off-Peak','Weekend'],
    datasets:[{
      data: [weekdayPeak, weekdayOff, weekend],
      backgroundColor: ['#ef4444','#f59e0b','#10b981']
    }]
  };
  if (pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx, {
    type:'pie', data:pieData, options:{      
      plugins:{legend:{position:'bottom'}}
    }
  });

  const barData = {
    labels: ['Weekday Peak','Weekday Off-Peak','Weekend'],
    datasets:[{
      label:'kWh',
      data:[weekdayPeak, weekdayOff, weekend],
      borderRadius:6,
      barThickness:40
    }]
  };
  if (barChart) barChart.destroy();
  barChart = new Chart(barCtx, {type:'bar', data:barData, options:{plugins:{legend:{display:false}}}});
}

function renderTable(rows){
  const wrap = document.getElementById('tableWrap');
  let html = '<table><thead><tr><th>#</th><th>MYT</th><th>Period</th><th>kWh</th></tr></thead><tbody>';
  rows.forEach((r,i)=>{
    html += `<tr><td>${i+1}</td><td>${r.myt.format('YYYY-MM-DD HH:mm')}</td><td>${r.period}</td><td>${r.total}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

// export CSV
let lastResult = null;
exportBtn.addEventListener('click', () => {
  if (!lastResult) return;
  const rows = [
    ['metric','value'],
    ['total_kWh', lastResult.total],
    ['weekday_peak_kWh', lastResult.weekdayPeak],
    ['weekday_offpeak_kWh', lastResult.weekdayOff],
    ['weekend_kWh', lastResult.weekend],
    ['rate_old_RM_per_kWh', lastResult.rateOld],
    ['rate_peak_RM_per_kWh', lastResult.ratePeak],
    ['rate_off_RM_per_kWh', lastResult.rateOff],    
    ['cost_old_RM', lastResult.costOld],
    ['cost_new_RM', lastResult.costNew],
    ['cost_diff_RM', lastResult.diff],
    ['cost_diff_percent', lastResult.percent]
  ];
  // create CSV text
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'tou_analysis_summary.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
